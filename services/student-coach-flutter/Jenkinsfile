pipeline {
    agent any

    environment {
        SERVICE_NAME = 'student-coach-flutter'
        DOCKER_IMAGE = "edupath/${SERVICE_NAME}"
        DOCKER_TAG = "${BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Flutter APK') {
            steps {
                script {
                    dir("services/${SERVICE_NAME}") {
                        bat "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} -t ${DOCKER_IMAGE}:latest ."
                    }
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    dir("services/${SERVICE_NAME}") {
                        bat "docker run --rm ${DOCKER_IMAGE}:${DOCKER_TAG} flutter test || exit 0"
                    }
                }
            }
        }

        stage('Analyze Code') {
            steps {
                script {
                    dir("services/${SERVICE_NAME}") {
                        bat "docker run --rm ${DOCKER_IMAGE}:${DOCKER_TAG} flutter analyze || exit 0"
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline for ${SERVICE_NAME} completed"
        }
        success {
            echo "✅ ${SERVICE_NAME} pipeline succeeded"
        }
        failure {
            echo "❌ ${SERVICE_NAME} pipeline failed"
        }
    }
}
